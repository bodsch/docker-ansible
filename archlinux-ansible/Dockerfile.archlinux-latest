FROM archlinux:base
LABEL maintainer="bodsch <bodo@boone-schulz.de>"

COPY rootfs/ /

RUN \
  pacman \
    --noconfirm --sync --refresh --sysupgrade \
      systemd \
      procps && \
  (cd /lib/systemd/system/sysinit.target.wants/; for i in *; do [ $i == systemd-tmpfiles-setup.service ] || rm -f $i; done); \
    rm -f /lib/systemd/system/default.target                 ; \
    rm -f /lib/systemd/system/multi-user.target.wants/*      ; \
    rm -f /lib/systemd/system/local-fs.target.wants/*        ; \
    rm -f /lib/systemd/system/sockets.target.wants/*udev*    ; \
    rm -f /lib/systemd/system/sockets.target.wants/*initctl* ; \
    rm -f /lib/systemd/system/basic.target.wants/*           ; \
    rm -f /lib/systemd/system/anaconda.target.wants/*        ; \
    rm -f /lib/systemd/system/systemd-timesyncd*             ; \
    rm -f /lib/systemd/system/systemd-resolved*              ; \
    rm -f /lib/systemd/system/systemd-networkd*              ; \
    rm -f /lib/systemd/system/systemd-homed*                 ; \
    rm -f /lib/systemd/system/systemd-userdbd*               ; \
    rm -f /lib/systemd/system/remote-cryptsetup*             ; \
    rm -rf /lib/systemd/system/remote-fs*                    ; \
    rm -f /lib/systemd/system/systemd-network-generator*     ; \
    rm -f /lib/systemd/system/systemd-pstore*                ; \
    rm -f /lib/systemd/system/systemd-boot-update            ; \
    rm -f /etc/systemd/system/dbus-org.freedesktop*          ; \
    rm -f /etc/systemd/system/*.wants/*                      && \
  # update package tree
  pacman \
    --noconfirm --sync --refresh --sysupgrade && \
  pacman \
    --noconfirm --sync --refresh \
      ansible \
      git \
      python-setuptools \
      python-pip \
      sudo \
      openssh \
      gawk \
      unzip \
      tar \
      rsync \
      fuse && \
  # Install ansible
  # python -m pip install --upgrade pip && \
  # python -m pip install ansible && \
  echo -e '[local]\nlocalhost ansible_connection=local' > /etc/ansible/hosts && \
  # cleanup
  pacman \
    --noconfirm --sync -cc && \
  rm -rf \
    /tmp/* \
    /usr/bin/find \
      /usr/lib/ -type d -name __pycache__ -exec rm -rf {} 2> /dev/null \; || true && \
  /usr/bin/info.sh

# VOLUME ["/sys/fs/cgroup"]

ENTRYPOINT ["/usr/lib/systemd/systemd"]
